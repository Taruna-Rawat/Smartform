REPORT Z_SF.

TABLES: EKKO.

TYPES: BEGIN OF TY_EKKO,
  EBELN TYPE EKKO-EBELN,
  AEDAT TYPE EKKO-AEDAT,
END OF TY_EKKO,

BEGIN OF TY_EKPO,
  EBELN TYPE EKPO-EBELN,
  MATNR TYPE EKPO-MATNR,
  EBELP TYPE EKPO-EBELP,
END OF TY_EKPO,

BEGIN OF TY_MARA,
  MATNR TYPE MARA-MATNR,
  ERNAM TYPE MARA-ERNAM,
END OF TY_MARA,

BEGIN OF TY_FINAL,
  EBELN TYPE EKKO-EBELN,
  AEDAT TYPE EKKO-AEDAT,
  MATNR TYPE EKPO-MATNR,
  EBELP TYPE EKPO-EBELP,
  ERNAM TYPE MARA-ERNAM,
END OF TY_FINAL.

DATA: IT_EKKO TYPE TABLE OF TY_EKKO,
      W_EKKO TYPE TY_EKKO,

      IT_EKPO TYPE TABLE OF TY_EKPO,
      W_EKPO TYPE TY_EKPO,

      IT_MARA TYPE TABLE OF TY_MARA,
      W_MARA TYPE TY_MARA,

      IT_MAIN TYPE TABLE OF TY_FINAL,
      W_MAIN TYPE TY_FINAL,

      F_NAME TYPE RS38L_FNAM.

SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE T1.
  SELECT-OPTIONS: PO FOR EKKO-EBELN.
SELECTION-SCREEN END OF BLOCK B1.

PERFORM GET_DATA.
PERFORM CALL_FORM.
PERFORM FINAL_TABLE.
PERFORM DISPLAY_FORM.

FORM GET_DATA.

  SELECT EBELN AEDAT
  FROM EKKO
  INTO TABLE IT_EKKO
  WHERE EBELN IN PO.

  SELECT EBELN MATNR EBELP
  FROM EKPO
  INTO TABLE IT_EKPO
  FOR ALL ENTRIES IN IT_EKKO
  WHERE EBELN EQ IT_EKKO-EBELN.

  SELECT MATNR ERNAM
  FROM MARA
  INTO TABLE IT_MARA
  FOR ALL ENTRIES IN IT_EKPO
  WHERE MATNR EQ IT_EKPO-MATNR.

ENDFORM.

FORM CALL_FORM.

  CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
  EXPORTING
    FORMNAME                 = 'Z_SF'
*   VARIANT                  = ' '
*   DIRECT_CALL              = ' '
 IMPORTING
   FM_NAME                  = F_NAME
 EXCEPTIONS
   NO_FORM                  = 1
   NO_FUNCTION_MODULE       = 2
   OTHERS                   = 3
          .
IF SY-SUBRC <> 0.
* Implement suitable error handling here
ENDIF.

ENDFORM.

FORM DISPLAY_FORM .

  CALL FUNCTION  F_NAME "V_FORM '/1BCDWB/SF00001310'
*   EXPORTING
*     ARCHIVE_INDEX              =
*     ARCHIVE_INDEX_TAB          =
*     ARCHIVE_PARAMETERS         =
*     CONTROL_PARAMETERS         =
*     MAIL_APPL_OBJ              =
*     MAIL_RECIPIENT             =
*     MAIL_SENDER                =
*     OUTPUT_OPTIONS             =
*     USER_SETTINGS              = 'X'
*   IMPORTING
*     DOCUMENT_OUTPUT_INFO       =
*     JOB_OUTPUT_INFO            =
*     JOB_OUTPUT_OPTIONS         =
    TABLES
      IT_MAIN                    = IT_MAIN
   EXCEPTIONS
     FORMATTING_ERROR           = 1
     INTERNAL_ERROR             = 2
     SEND_ERROR                 = 3
     USER_CANCELED              = 4
     OTHERS                     = 5
            .
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.


ENDFORM.

FORM FINAL_TABLE.

  LOOP AT IT_EKKO INTO W_EKKO.

    W_MAIN-EBELN = W_EKKO-EBELN.
    W_MAIN-AEDAT = W_EKKO-AEDAT.

    READ TABLE IT_EKPO INTO W_EKPO WITH KEY EBELN = W_EKKO-EBELN.
    IF SY-SUBRC = 0.
      W_MAIN-MATNR = W_EKPO-MATNR.
      W_MAIN-EBELP = W_EKPO-EBELP.
    ENDIF.

    READ TABLE IT_MARA INTO W_MARA WITH KEY MATNR = W_EKPO-MATNR.
    IF SY-SUBRC = 0.
      W_MAIN-ERNAM = W_MARA-ERNAM.
    ENDIF.

    APPEND W_MAIN TO IT_MAIN.
    CLEAR W_MAIN.

  ENDLOOP.
ENDFORM.
